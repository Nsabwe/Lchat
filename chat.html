<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Responsive Chat Page</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family: Arial, Helvetica, sans-serif;}
html,body{height:100%;background:#f0f2f5;}
.top-bar{height:60px;background:#1877f2;color:white;display:flex;align-items:center;justify-content:space-between;padding:0 15px;font-size:1.1rem;font-weight:bold;position:fixed;top:0;width:100%;z-index:10;}
.top-bar-left,.top-bar-right{display:flex;align-items:center;gap:15px;}
#chatHeader{display:flex;justify-content:space-between;align-items:center;padding:5px 15px;background:#e4e6eb;position:fixed;top:60px;width:100%;z-index:9;}
.content-area{position:fixed;top:100px;bottom:120px;width:100%;background:white;overflow-y:auto;padding:10px;}
.message-container{display:flex;gap:10px;margin-bottom:10px;}
.message-container.user{flex-direction:row-reverse;}
.profile{width:40px;height:40px;border-radius:50%;}
.message{padding:10px;border-radius:15px;max-width:70%;}
.user{background:#DCF8C6;}
.other{background:#e4e6eb;}
.bottom-bar{position:fixed;bottom:0;width:100%;background:#f0f2f5;padding:8px;}
textarea{flex:1;border-radius:20px;padding:10px;border:none;}
.send-btn{background:#1877f2;color:white;border-radius:50%;padding:10px;border:none;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:20;}
.modal-content{background:white;padding:20px;border-radius:10px;width:90%;max-width:500px;}
.online-dot{width:10px;height:10px;background:green;border-radius:50%;position:absolute;bottom:0;right:0;border:2px solid white;}
</style>
</head>

<body>

<div class="top-bar">
    <div class="top-bar-left">Chat</div>
    <div class="top-bar-right">
        <i class="fa-solid fa-user" onclick="profileModal.style.display='flex'"></i>
    </div>
</div>

<div id="chatHeader">
    <span id="onlineCount">0 Online</span>
    <span id="typingIndicator"></span>
</div>

<div class="content-area" id="contentArea"></div>

<div class="bottom-bar">
    <div style="display:flex;gap:5px;">
        <textarea id="messageInput" placeholder="Type a message..."></textarea>
        <button class="send-btn" id="sendBtn">
            <i class="fa-solid fa-paper-plane"></i>
        </button>
    </div>
</div>

<input type="file" id="fileInput" hidden>

<div id="profileModal" class="modal">
    <div class="modal-content">
        <h3>Set Profile</h3>
        <input id="userNameInput" placeholder="Name"><br><br>
        <input type="file" id="profileFileInput"><br><br>
        <button onclick="saveProfile()">Save</button>
    </div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

<script>
/* ================= BACKEND ================= */
const BACKEND_URL = "https://cchat-11.onrender.com";
const socket = io(BACKEND_URL);

/* ================= STATE ================= */
let currentUser = {};
let onlineUsers = [];

/* ================= HELPERS ================= */
const toBase64 = file => new Promise(res=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.readAsDataURL(file);
});

/* ================= PROFILE ================= */
async function saveProfile(){
    const name = userNameInput.value.trim();
    const file = profileFileInput.files[0];
    if(!name || !file) return alert("Fill all fields");

    const profile = await toBase64(file);
    currentUser = { name, profile };

    await fetch(`${BACKEND_URL}/saveProfileURI`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(currentUser)
    });

    socket.emit("join", currentUser);
    profileModal.style.display="none";
    loadMessages();
}

/* ================= MESSAGES ================= */
function addMessage(msg,isUser){
    const div = document.createElement("div");
    div.className = `message-container ${isUser?"user":""}`;

    div.innerHTML = `
        <img class="profile" src="${msg.senderProfile}">
        <div class="message ${isUser?"user":"other"}">
            <b>${msg.senderName}</b><br>
            ${msg.content}<br>
            <small>${new Date(msg.timestamp).toLocaleTimeString()}</small>
        </div>
    `;
    contentArea.appendChild(div);
    contentArea.scrollTop = contentArea.scrollHeight;
}

async function loadMessages(){
    const res = await fetch(`${BACKEND_URL}/messages`);
    const data = await res.json();
    data.forEach(m=>addMessage(m,m.senderName===currentUser.name));
}

/* ================= SEND ================= */
sendBtn.onclick = async ()=>{
    if(!currentUser.name) return alert("Set profile");
    const text = messageInput.value.trim();
    if(!text) return;

    const msg = {
        senderName: currentUser.name,
        senderProfile: currentUser.profile,
        type:"text",
        content:text,
        timestamp:new Date()
    };

    addMessage(msg,true);
    messageInput.value="";

    const res = await fetch(`${BACKEND_URL}/saveMessageURI`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(msg)
    });
    const saved = await res.json();
    socket.emit("messageSent", saved);
};

/* ================= SOCKET ================= */
socket.on("newMessage", msg=>{
    addMessage(msg, msg.senderName===currentUser.name);
});

socket.on("onlineUsers", users=>{
    onlineUsers = users;
    onlineCount.textContent = `${users.length} Online`;
});

socket.on("userTyping", d=>{
    typingIndicator.textContent = `${d.user} typing...`;
});

socket.on("userStopTyping", ()=>{
    typingIndicator.textContent = "";
});
</script>
</body>
</html>