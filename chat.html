<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:#f0f2f5;height:100vh;}

/* TOP BAR */
.top-bar{
    height:60px;background:#1877f2;color:white;
    display:flex;align-items:center;justify-content:space-between;
    padding:0 15px;font-weight:bold;
    position:fixed;width:100%;top:0;z-index:10;
}

/* HEADER */
#chatHeader{
    position:fixed;top:60px;width:100%;
    background:#e4e6eb;padding:8px 15px;z-index:9;
}

/* TYPING / RECORDING */
#typingStatus,#recordingStatus{
    font-size:0.8rem;color:gray;
}

/* CONTENT */
.content-area{
    position:fixed;top:120px;bottom:160px;width:100%;
    overflow-y:auto;background:white;padding:10px;
}

/* MESSAGE */
.message-container{display:flex;gap:10px;margin-bottom:10px}
.message-container.user{flex-direction:row-reverse}
.profile-wrapper{position:relative;cursor:pointer}
.profile{width:40px;height:40px;border-radius:50%;object-fit:cover}
.status-dot{
    position:absolute;bottom:2px;right:2px;
    width:10px;height:10px;border-radius:50%;
    border:2px solid white
}
.status-online{background:#2ecc71}
.status-offline{background:#bbb}

.message{
    padding:10px;border-radius:15px;max-width:70%;
    position:relative;background:#e4e6eb;
}
.message.user{background:#DCF8C6}
.message-header{font-size:0.75rem;color:#555;margin-bottom:4px}
.message img{max-width:220px;border-radius:10px;cursor:pointer}
audio{width:220px}

/* REACTIONS */
.reactions{display:flex;gap:6px;margin-top:4px;font-size:.8rem}
.reaction{
    background:#eee;padding:2px 6px;border-radius:12px;
    cursor:pointer;position:relative
}
.reaction.active{background:#1877f2;color:white}

/* EMOJI PICKER */
.emoji-picker{
    position:absolute;bottom:110%;left:0;
    width:260px;max-height:200px;
    background:white;border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,.2);
    padding:8px;
    display:grid;grid-template-columns:repeat(8,1fr);
    gap:6px;overflow-y:auto;z-index:20
}
.emoji-picker span{cursor:pointer;font-size:20px}
.emoji-picker span:hover{transform:scale(1.2)}

/* BOTTOM BAR */
.bottom-bar{
    position:fixed;bottom:0;width:100%;
    background:#f0f2f5;padding:8px
}
#voicePreviewContainer{
    display:none; padding:5px; background:#fff; border-top:1px solid #ccc; border-radius:10px; margin-bottom:5px;
}
textarea{width:100%;border-radius:20px;padding:10px;border:none;resize:none;}
.input-container{display:flex;gap:5px}
.send-btn{
    background:#1877f2;color:white;border:none;
    border-radius:50%;padding:10px
}
.bottom-buttons{display:flex;gap:10px;margin-top:5px}
.bottom-buttons button{
    border:none;background:white;border-radius:50%;padding:8px
}

/* MODALS */
.modal{
    display:none;position:fixed;top:0;left:0;
    width:100%;height:100%;
    background:rgba(0,0,0,.6);
    justify-content:center;align-items:center;z-index:30
}
.modal-content{
    background:white;padding:20px;border-radius:10px;
    width:90%;max-width:500px;position:relative
}
.close-btn{
    position:absolute;top:10px;right:10px;
    background:red;color:white;border:none;padding:5px 10px
}

/* WAVEFORM */
.waveform-container {
    width:220px;height:50px;
    background:#e4e6eb;border-radius:8px;
    display:flex;align-items:flex-end;gap:2px;margin-top:5px
}
.waveform-bar{width:2px;background:#1877f2;height:5px;transition:height 0.05s}
</style>
</head>
<body>

<div class="top-bar">
    Chat CLNS
    <i class="fa-solid fa-user" onclick="profileModal.style.display='flex'"></i>
</div>

<div id="chatHeader">
    <div id="onlineCount">0 Online</div>
    <div id="typingStatus"></div>
    <div id="recordingStatus"></div>
</div>

<div class="content-area" id="contentArea"></div>

<div class="bottom-bar">
    <!-- VOICE PREVIEW AREA -->
    <div id="voicePreviewContainer"></div>

    <div class="input-container">
        <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
        <button class="send-btn" id="sendBtn"><i class="fa fa-paper-plane"></i></button>
    </div>
    <div class="bottom-buttons">
        <button onclick="openFilePicker()"><i class="fa fa-paperclip"></i></button>
        <button onclick="toggleRecording()"><i class="fa fa-microphone"></i></button>
    </div>
</div>

<input type="file" id="fileInput" multiple hidden>

<!-- PROFILE MODAL -->
<div id="profileModal" class="modal">
    <div class="modal-content">
        <h3>Set Profile</h3>
        <input id="userNameInput" placeholder="Name"><br><br>
        <input type="file" id="profileFileInput" accept="image/*"><br><br>
        <button onclick="saveProfile()">Save</button>
        <button class="close-btn" onclick="profileModal.style.display='none'">X</button>
    </div>
</div>

<!-- IMAGE MODAL -->
<div id="imageModal" class="modal">
    <div class="modal-content">
        <img id="modalImage" style="width:100%">
        <button class="close-btn" onclick="imageModal.style.display='none'">X</button>
    </div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
const socket = io("https://chacha2004-8-0xjx.onrender.com");
const DEFAULT_PROFILE="https://via.placeholder.com/40";
let currentUser={}, typingTimer, mediaRecorder, audioChunks=[], recording=false;
let audioCtx, analyser, dataArray, source, waveformContainer;
const EMOJIS=[..."ðŸ˜€ðŸ˜ðŸ˜‚ðŸ¤£ðŸ˜ƒðŸ˜„ðŸ˜…ðŸ˜†ðŸ˜‰ðŸ˜ŠðŸ˜ðŸ˜˜ðŸ˜—ðŸ˜™ðŸ˜šðŸ˜‹ðŸ˜œðŸ˜ðŸ˜ŽðŸ¤©ðŸ¤”ðŸ™„ðŸ˜ðŸ˜£ðŸ˜¥ðŸ˜®ðŸ˜ªðŸ˜«ðŸ˜´ðŸ˜­ðŸ˜¡ðŸ‘ðŸ‘ŽðŸ‘ðŸ™ŒðŸ™ðŸ’ªðŸ”¥ðŸ’¯â¤ï¸ðŸ§¡ðŸ’›ðŸ’šðŸ’™ðŸ’œðŸ¤ðŸ¤ŽðŸŽ‰âœ¨â­ðŸŒŸâš¡"];
const voicePreviewContainer = document.getElementById("voicePreviewContainer");

/* UTIL */
function toBase64(file){return new Promise(r=>{const fr=new FileReader();fr.onload=()=>r(fr.result);fr.readAsDataURL(file);});}

/* PROFILE */
async function saveProfile(){
    const name=userNameInput.value;
    const file=profileFileInput.files[0];
    if(!name||!file)return alert("Missing");
    currentUser={name,profile:await toBase64(file)};
    socket.emit("join",currentUser);
    profileModal.style.display='none';
    loadMessages();
}

/* IMAGE MODAL */
function openImageModal(src){modalImage.src=src;imageModal.style.display="flex";}

/* EMOJI PICKER */
function createEmojiPicker(id){
    const p=document.createElement("div");
    p.className="emoji-picker";
    EMOJIS.forEach(e=>{
        const s=document.createElement("span");
        s.textContent=e;
        s.onclick=()=>{socket.emit("reactMessage",{_id:id,emoji:e,user:currentUser.name});p.remove();}
        p.appendChild(s);
    });
    return p;
}

/* ADD MESSAGE */
function addMessage(msg,isUser){
    const c=document.createElement("div");
    c.className="message-container"+(isUser?" user":"");
    c.dataset.id=msg._id||"";

    c.ondblclick=async()=>{
        if(msg._id && confirm("Delete message?")){
            await fetch(`/messages/${msg._id}`,{method:"DELETE"});
        }
    };

    const pw=document.createElement("div");
    pw.className="profile-wrapper";
    pw.onclick=()=>openImageModal(msg.senderProfile||DEFAULT_PROFILE);

    const img=document.createElement("img");
    img.src=msg.senderProfile||DEFAULT_PROFILE;
    img.className="profile";

    const dot=document.createElement("span");
    dot.className="status-dot "+(msg.isOnline?"status-online":"status-offline");
    pw.append(img,dot);

    const m=document.createElement("div");
    m.className="message"+(isUser?" user":"");

    const h=document.createElement("div");
    h.className="message-header";
    h.textContent=`${msg.senderName} â€¢ ${new Date(msg.timestamp).toLocaleTimeString()}`;
    m.appendChild(h);

    if(msg.type==="text") m.append(msg.content);
    if(msg.type==="image"){const i=document.createElement("img");i.src=msg.content;i.onclick=()=>openImageModal(msg.content);m.appendChild(i);}
    if(msg.type==="file"){const a=document.createElement("a");a.href=msg.content;a.download=msg.fileName;a.textContent="ðŸ“„ "+msg.fileName;m.appendChild(a);}
    if(msg.type==="voice"){const a=document.createElement("audio");a.controls=true;a.src=msg.content;m.appendChild(a);}

    const r=document.createElement("div");r.className="reactions";
    if(msg.reactions) for(const [e,u] of Object.entries(msg.reactions)){
        const s=document.createElement("span");
        s.className="reaction"+(u.includes(currentUser.name)?" active":"");
        s.textContent=`${e} ${u.length}`;
        r.appendChild(s);
    }
    m.appendChild(r);

    m.oncontextmenu=e=>{
        e.preventDefault();document.querySelector(".emoji-picker")?.remove();
        m.appendChild(createEmojiPicker(msg._id));
    };

    c.append(pw,m);
    contentArea.appendChild(c);
    contentArea.scrollTop=contentArea.scrollHeight;
}

/* LOAD */
async function loadMessages(){
    const res=await fetch("/messages");
    (await res.json()).forEach(m=>addMessage(m,m.senderName===currentUser.name));
}

/* SEND TEXT */
sendBtn.onclick=async()=>{
    const text=messageInput.value.trim();if(!text)return;
    if(!currentUser.name){alert("Please set profile!"); profileModal.style.display='flex'; return;}
    const msg={senderName:currentUser.name,senderProfile:currentUser.profile,type:"text",content:text,timestamp:new Date()};
    const r=await fetch("/saveMessageURI",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(msg)});
    socket.emit("messageSent",await r.json());
    messageInput.value="";
};

/* FILE */
function openFilePicker(){fileInput.click();}
fileInput.onchange=async()=>{
    for(const f of fileInput.files){
        const msg={senderName:currentUser.name,senderProfile:currentUser.profile,
            type:f.type.startsWith("image/")?"image":"file",
            content:await toBase64(f),fileName:f.name,timestamp:new Date()};
        const r=await fetch("/saveMessageURI",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(msg)});
        socket.emit("messageSent",await r.json());
    }
};

/* VOICE RECORDING */
async function toggleRecording(){
    if(!recording){
        recording=true;
        recordingStatus.textContent="ðŸŽ™ï¸ Recording...";
        voicePreviewContainer.innerHTML=""; voicePreviewContainer.style.display="flex"; voicePreviewContainer.style.flexDirection="column";

        const stream=await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder=new MediaRecorder(stream); audioChunks=[];
        mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
        mediaRecorder.start();

        waveformContainer=document.createElement("div"); waveformContainer.className="waveform-container";
        for(let i=0;i<32;i++){const bar=document.createElement("div");bar.className="waveform-bar"; waveformContainer.appendChild(bar);}
        voicePreviewContainer.appendChild(waveformContainer);

        audioCtx=new (window.AudioContext||window.webkitAudioContext)();
        source=audioCtx.createMediaStreamSource(stream);
        analyser=audioCtx.createAnalyser(); analyser.fftSize=64;
        source.connect(analyser); dataArray=new Uint8Array(analyser.frequencyBinCount);

        function updateWaveform(){
            analyser.getByteFrequencyData(dataArray);
            waveformContainer.childNodes.forEach((bar,i)=>{bar.style.height=(dataArray[i]/2)+"px";});
            if(recording) requestAnimationFrame(updateWaveform);
        } updateWaveform();

    } else stopRecording();
}

async function stopRecording(){
    if(!recording) return; recording=false;
    mediaRecorder.stop();
    mediaRecorder.onstop=async()=>{
        const audioBlob=new Blob(audioChunks,{type:"audio/webm"});
        waveformContainer?.remove();

        const audioPreview=document.createElement("audio");
        audioPreview.controls=true; audioPreview.src=URL.createObjectURL(audioBlob); audioPreview.style.marginBottom="5px";

        const sendBtn=document.createElement("button"); sendBtn.textContent="Send"; sendBtn.style.marginRight="5px";
        sendBtn.onclick=async()=>{
            if(!currentUser.name||!currentUser.profile){alert("Please set profile!"); profileModal.style.display='flex'; return;}
            const msg={senderName:currentUser.name,senderProfile:currentUser.profile,type:"voice",content:await toBase64(audioBlob),timestamp:new Date()};
            const r=await fetch("/saveMessageURI",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(msg)});
            socket.emit("messageSent",await r.json());
            voicePreviewContainer.style.display="none"; voicePreviewContainer.innerHTML="";
        };

        const cancelBtn=document.createElement("button"); cancelBtn.textContent="Cancel";
        cancelBtn.onclick=()=>{voicePreviewContainer.style.display="none"; voicePreviewContainer.innerHTML="";};

        const btnContainer=document.createElement("div"); btnContainer.style.display="flex";
        btnContainer.append(sendBtn,cancelBtn);

        voicePreviewContainer.append(audioPreview,btnContainer);
    };
}

/* TYPING */
messageInput.oninput=()=>{
    if(!currentUser.name) return;
    socket.emit("typing",currentUser.name);
    clearTimeout(typingTimer);
    typingTimer=setTimeout(()=>socket.emit("stopTyping"),1000);
};

/* SOCKET EVENTS */
let typingUsers=new Set();
socket.on("typing",name=>{if(name!==currentUser.name){typingUsers.add(name);typingStatus.textContent=[...typingUsers].join(", ")+" is typing...";}});
socket.on("stopTyping",()=>{typingUsers.clear();typingStatus.textContent="";});
socket.on("onlineUsers",u=>onlineCount.textContent=u.length+" Online");
socket.on("newMessage",m=>addMessage(m,m.senderName===currentUser.name));
socket.on("messageDeleted",id=>document.querySelector(`[data-id="${id}"]`)?.remove());
socket.on("reactionUpdate",d=>{const el=document.querySelector(`[data-id="${d.messageId}"]`);if(el){el.remove();addMessage(d.message,false);}});
</script>
</body>
</html>