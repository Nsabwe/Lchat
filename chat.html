<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif;}
html,body{height:100%;background:#f0f2f5;}
.top-bar{height:60px;background:#1877f2;color:white;display:flex;align-items:center;justify-content:space-between;padding:0 15px;font-weight:bold;position:fixed;top:0;width:100%;z-index:10;}
.top-bar i{cursor:pointer;font-size:1.2rem;}
#onlineCount{font-size:0.9rem;}
.content-area{position:fixed;top:60px;bottom:60px;left:0;right:0;background:white;overflow-y:auto;padding:10px;}
.message-container{display:flex;gap:10px;margin-bottom:10px;align-items:flex-start;position:relative;}
.message-container.user{flex-direction:row-reverse;}
.message{padding:10px;border-radius:15px;max-width:70%;word-wrap:break-word;position:relative;}
.message.user{background:#DCF8C6;color:black;}
.message.other{background:#e4e6eb;color:black;}
.profile{width:40px;height:40px;border-radius:50%;object-fit:cover;cursor:pointer;}
.online-dot{width:10px;height:10px;background:green;border-radius:50%;position:absolute;bottom:0;right:0;border:2px solid white;}
.timestamp{font-size:0.7rem;color:gray;margin-top:3px;}
.status{font-size:0.65rem;color:gray;position:absolute;bottom:-15px;right:5px;}
.bottom-bar{position:fixed;bottom:0;left:0;width:100%;background:#f0f2f5;padding:8px;display:flex;gap:5px;}
textarea{border-radius:20px;padding:10px;resize:none;border:none;flex:1;}
.send-btn{background:#1877f2;color:white;border-radius:50%;padding:10px;border:none;cursor:pointer;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:20;}
.modal .modal-content{background:white;padding:20px;border-radius:10px;width:90%;max-width:500px;overflow-y:auto;max-height:80%;}
.modal button{padding:10px 20px;background:#1877f2;color:white;border:none;border-radius:5px;cursor:pointer;margin-top:5px;}
</style>
</head>
<body>

<!-- Top Bar -->
<div class="top-bar">
    <div>Advanced Chat</div>
    <div>
        <span id="onlineCount">0 Online</span>
        <i class="fa-solid fa-clock" style="margin-left:10px;cursor:pointer;" onclick="openHistory()" title="History"></i>
        <i class="fa-solid fa-gift" style="margin-left:10px;cursor:pointer;position:relative;" onclick="openTip()" title="Tip">
            <span id="tipCount" style="position:absolute;top:-5px;right:-10px;background:red;color:white;font-size:0.7rem;padding:2px 5px;border-radius:50%;">0</span>
        </i>
        <i class="fa-solid fa-user" style="margin-left:10px;" onclick="document.getElementById('profileModal').style.display='flex'" title="Profile"></i>
    </div>
</div>

<!-- Content Area -->
<div class="content-area" id="contentArea"></div>

<!-- Bottom Bar -->
<div class="bottom-bar">
    <textarea id="messageInput" placeholder="Type a message..."></textarea>
    <button class="send-btn" id="sendBtn"><i class="fa-solid fa-paper-plane"></i></button>
    <input type="file" id="fileInput" multiple hidden>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="modal">
    <div class="modal-content">
        <h3>Set Your Profile</h3>
        <input type="text" id="userNameInput" placeholder="Enter your name"><br>
        <input type="file" id="profileFileInput" accept="image/*"><br>
        <button onclick="saveProfile()">Save</button>
    </div>
</div>

<!-- History Modal -->
<div id="historyModal" class="modal">
    <div class="modal-content">
        <h3>Chat History</h3>
        <div id="historyContent"></div>
        <button class="close-btn" onclick="document.getElementById('historyModal').style.display='none'">Close</button>
    </div>
</div>

<!-- Tip Modal -->
<div id="tipModal" class="modal">
    <div class="modal-content">
        <h3>Send a Tip</h3>
        <input type="number" id="tipAmount" placeholder="Amount"><br>
        <button id="sendTipBtn">Send Tip</button>
        <button class="close-btn" onclick="document.getElementById('tipModal').style.display='none'">Close</button>
    </div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
let currentUser = { name:'', profile:'' };
let onlineUsers = [];
const contentArea = document.getElementById('contentArea');

// Updated Backend URL
const BACKEND_URL = "https://fada-4.onrender.com";
const socket = io(BACKEND_URL, { transports:['websocket','polling'] });

function toBase64(file){
    return new Promise((res,rej)=>{
        const reader = new FileReader();
        reader.onload = ()=>res(reader.result);
        reader.onerror = err=>rej(err);
        reader.readAsDataURL(file);
    });
}

// Save profile
function saveProfile(){
    const name = document.getElementById('userNameInput').value.trim();
    const file = document.getElementById('profileFileInput').files[0];
    if(!name || !file) return alert("Enter name and select picture!");
    toBase64(file).then(base64=>{
        currentUser = { name, profile: base64 };
        document.getElementById('profileModal').style.display='none';
        socket.emit('join', currentUser);
        loadHistory();
    });
}

// Add message
function addMessage(msg, isUser){
    const container = document.createElement('div');
    container.className='message-container';
    container.dataset.id = msg._id || '';
    if(isUser) container.classList.add('user');

    const profileWrapper = document.createElement('div');
    profileWrapper.style.position='relative';

    const img = document.createElement('img');
    img.src = msg.senderProfile || 'https://i.pravatar.cc/150';
    img.className='profile';
    img.onclick = ()=>{ 
        const modal = document.createElement('div');
        modal.className='modal';
        modal.style.display='flex';
        modal.onclick=()=>modal.remove();
        modal.innerHTML=`<img src="${msg.senderProfile}" style="max-width:90%; max-height:90%; border-radius:10px;">`;
        document.body.appendChild(modal);
    };

    const dot = document.createElement('span');
    dot.className='online-dot';
    dot.style.display=onlineUsers.some(u=>u.name===msg.senderName)?'block':'none';

    profileWrapper.appendChild(img);
    profileWrapper.appendChild(dot);
    container.appendChild(profileWrapper);

    const content = document.createElement('div');
    content.className='message '+(isUser?'user':'other');

    if(msg.type==='text') content.textContent = msg.content;
    else if(msg.type==='image'){
        const image = document.createElement('img');
        image.src = msg.content;
        image.style.maxWidth='250px';
        image.style.borderRadius='10px';
        content.appendChild(image);
    } else if(msg.type==='document'){
        const docName = msg.content.split('/').pop();
        content.innerHTML=`<i class="fa-solid fa-file"></i> <a href="${msg.content}" target="_blank">${docName}</a>`;
    }

    const timeEl = document.createElement('div');
    timeEl.className='timestamp';
    timeEl.textContent=new Date(msg.timestamp||Date.now()).toLocaleTimeString();
    content.appendChild(timeEl);

    const statusEl = document.createElement('div');
    statusEl.className='status';
    statusEl.textContent = isUser ? (msg.status || "✓ sending") : "";
    content.appendChild(statusEl);

    container.appendChild(content);
    contentArea.appendChild(container);
    contentArea.scrollTop=contentArea.scrollHeight;

    container.ondblclick=()=>{
        if(msg._id){
            socket.emit('deleteMessage', msg._id);
            container.remove();
        }
    };
    return statusEl;
}

// Load chat history
function loadHistory(){
    fetch(`${BACKEND_URL}`)
    .then(r=>r.json())
    .then(data=>{
        contentArea.innerHTML='';
        data.forEach(m=>addMessage(m,m.senderName===currentUser.name));
    });
}

// Send text
document.getElementById('sendBtn').addEventListener('click',()=>{
    if(!currentUser.name||!currentUser.profile) return alert("Set profile first!");
    const text=document.getElementById('messageInput').value.trim();
    if(!text) return;
    const msg={senderName:currentUser.name, senderProfile:currentUser.profile, type:'text', content:text, timestamp:Date.now(), status:'sending'};
    const statusEl=addMessage(msg,true);
    fetch(`${BACKEND_URL}/saveMessageURI`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(msg)
    }).then(res=>res.json()).then(saved=>{
        statusEl.textContent="✓ delivered";
        socket.emit('messageSent', saved);
    });
    document.getElementById('messageInput').value='';
});

// File upload
document.getElementById('fileInput').addEventListener('change', async function(){
    for(const file of this.files){
        const base64 = await toBase64(file);
        const type=file.type.startsWith('image/')?'image':'document';
        const msg={senderName:currentUser.name, senderProfile:currentUser.profile, type, content:base64, timestamp:Date.now(), status:'sending'};
        const statusEl=addMessage(msg,true);
        fetch(`${BACKEND_URL}/saveMessageURI`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(msg)
        }).then(res=>res.json()).then(saved=>{
            statusEl.textContent="✓ delivered";
            socket.emit('messageSent', saved);
        });
    }
    this.value='';
});

// Modals
function openHistory(){
    const historyModal=document.getElementById('historyModal');
    const historyContent=document.getElementById('historyContent');
    historyContent.innerHTML='';
    fetch(`${BACKEND_URL}`).then(r=>r.json()).then(msgs=>{
        msgs.forEach(msg=>{
            const div=document.createElement('div');
            div.style.padding="5px"; div.style.borderBottom="1px solid #ccc";
            div.innerHTML=`<strong>${msg.senderName}</strong>: ${msg.type==='text'?msg.content:(msg.type==='image'?'<i>Image</i>':'<i>Document</i>')} 
            <span style="float:right;font-size:0.7rem;color:gray;">${new Date(msg.timestamp).toLocaleTimeString()}</span>`;
            historyContent.appendChild(div);
        });
    });
    historyModal.style.display='flex';
}

function openTip(){document.getElementById('tipModal').style.display='flex';}
document.getElementById('sendTipBtn').onclick=()=>{
    const amount=document.getElementById('tipAmount').value;
    if(amount && amount>0){
        socket.emit('sendTip',{to:currentUser.name,amount:Number(amount)});
        document.getElementById('tipModal').style.display='none';
        document.getElementById('tipAmount').value='';
    } else alert("Enter valid amount");
};

// Socket events
socket.on('newMessage', msg=>addMessage(msg,msg.senderName===currentUser.name));
socket.on('onlineUsers', users=>{
    onlineUsers=users;
    document.getElementById('onlineCount').textContent=`${users.length} Online`;
    document.querySelectorAll('.online-dot').forEach(dot=>{
        const container=dot.closest('.message-container');
        const name=container.querySelector('.message div')?.textContent||'';
        dot.style.display=users.some(u=>u.name===name)?'block':'none';
    });
});
socket.on('deleteMessage', id=>{
    const el=document.querySelector(`[data-id='${id}']`);
    if(el) el.remove();
});
socket.on('tipUpdate',(total,userName)=>{
    if(!userName || userName===currentUser.name){
        const tipBadge=document.getElementById('tipCount');
        tipBadge.textContent=total;
        tipBadge.style.transform="scale(1.5)";
        setTimeout(()=>tipBadge.style.transform="scale(1)",300);
    }
});

// Show profile modal on load
window.onload=()=>{if(!currentUser.name||!currentUser.profile) document.getElementById('profileModal').style.display='flex';};
</script>
</body>
</html>