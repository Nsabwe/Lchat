<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Responsive Chat Page</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family: Arial, Helvetica, sans-serif;}
html,body{height:100%;background:#f0f2f5;}

/* ðŸ”µ TOP BAR */
.top-bar{height:60px;background:#1877f2;color:white;display:flex;align-items:center;justify-content:space-between;padding:0 15px;font-size:1.1rem;font-weight:bold;position:fixed;top:0;left:0;width:100%;z-index:10;}
.top-bar-left,.top-bar-right{display:flex;align-items:center;gap:15px;}
.top-bar i{cursor:pointer;font-size:1.2rem;}

/* Chat Header */
#chatHeader{display:flex;justify-content:space-between;align-items:center;padding:5px 15px;background:#e4e6eb;position:fixed;top:60px;left:0;width:100%;z-index:9;}
#typingIndicator{font-size:0.9rem;color:gray;margin-left:10px;}

/* ðŸ“œ MAIN SCROLLABLE AREA */
.content-area{position:fixed;top:100px;bottom:120px;left:0;right:0;background:white;overflow-y:auto;padding:10px;}

/* ðŸ’¬ MESSAGE BUBBLES */
.message-container{display:flex;align-items:flex-start;gap:10px;margin-bottom:10px;transition: all 0.2s;}
.message-container.user{flex-direction:row-reverse;}
.message-container img.profile{width:40px;height:40px;border-radius:50%;object-fit:cover;}
.message{padding:10px;border-radius:15px;max-width:70%;word-wrap:break-word;position:relative;}
.message.user{background:#DCF8C6;color:black;}
.message.other{background:#e4e6eb;color:black;}
.message .status{font-size:0.65rem;color:gray;position:absolute;bottom:-15px;right:5px;}

/* Online dot */
.online-dot{width:10px;height:10px;background:green;border-radius:50%;position:absolute;bottom:0;right:0;border:2px solid white;}

/* ðŸ“Ž ATTACHMENTS */
.attachment{background:#f1f1f1;border-radius:10px;padding:8px;max-width:70%;}
.attachment img{width:100%;border-radius:10px;max-height:250px;object-fit:cover;}
.doc{display:flex;align-items:center;gap:8px;font-size:0.85rem;}
.doc i{font-size:1.5rem;color:#1877f2;}

/* Timestamp and name */
.timestamp{font-size:0.7rem;color:gray;margin-top:3px;}

/* ðŸ”µ BOTTOM BAR */
.bottom-bar{position:fixed;bottom:0;left:0;width:100%;background:#f0f2f5;padding:8px;}
.input-container{display:flex;gap:5px;}
textarea{border-radius:20px;padding:10px;resize:none;border:none;flex:1;}
.send-btn{background:#1877f2;color:white;border-radius:50%;padding:10px;border:none;cursor:pointer;}
.bottom-buttons{display:flex;gap:10px;margin-top:5px;}
.bottom-buttons button{background:white;color:#1877f2;border-radius:50%;padding:8px;border:none;cursor:pointer;}

/* Tip badge smooth animation */
#tipCount{transition: all 0.3s ease-in-out; transform-origin:center; display:inline-block;}

/* ðŸ”µ NEW MESSAGE BADGE */
#newMessageBadge{
    display:none; position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
    background:#1877f2; color:white; padding:5px 10px; border-radius:20px; cursor:pointer; z-index:5;
}

/* ðŸ”µ MODALS */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:20;}
.modal .modal-content{background:white;padding:20px;border-radius:10px;width:90%;max-width:500px;position:relative;overflow-y:auto;max-height:80%;}
.modal h3{margin-bottom:10px;}
.modal button.close-btn{position:absolute;top:10px;right:10px;background:red;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;}
.modal input{width:80%;padding:8px;margin:10px 0;}
.modal button{padding:10px 20px;background:#1877f2;color:white;border:none;border-radius:5px;cursor:pointer;}
</style>
</head>
<body>

<!-- ðŸ”µ TOP BAR -->
<div class="top-bar">
    <div class="top-bar-left">
        <i class="fa-solid fa-arrow-left" onclick="window.location='index.html'"></i>
        Chat
    </div>
    <div class="top-bar-right">
        <i class="fa-solid fa-user" onclick="document.getElementById('profileModal').style.display='flex'"></i>
    </div>
</div>

<!-- Chat Header -->
<div id="chatHeader">
    <div>
        <span id="onlineCount">0 Online</span>
        <span id="typingIndicator"></span>
    </div>
    <div>
        <i class="fa-solid fa-clock" title="History" style="margin-right:10px; cursor:pointer;" onclick="openHistory()"></i>
        <i class="fa-solid fa-gift" title="Tip" style="cursor:pointer; position:relative;" onclick="openTip()">
            <span id="tipCount" style="position:absolute; top:-5px; right:-10px; background:red; color:white; font-size:0.7rem; padding:2px 5px; border-radius:50%;">0</span>
        </i>
    </div>
</div>

<!-- ðŸ“œ SCROLLABLE CONTENT -->
<div class="content-area" id="contentArea"></div>
<div id="newMessageBadge">New Messages</div>

<!-- ðŸ”µ BOTTOM BAR -->
<div class="bottom-bar">
    <div class="input-container">
        <textarea id="messageInput" placeholder="Type a message..."></textarea>
        <button class="send-btn" id="sendBtn">
            <i class="fa-solid fa-paper-plane"></i>
        </button>
    </div>
    <div class="bottom-buttons">
        <button><i class="fa-solid fa-face-smile"></i></button>
        <button onclick="openFilePicker()"><i class="fa-solid fa-paperclip"></i></button>
        <button><i class="fa-solid fa-microphone"></i></button>
    </div>
</div>

<input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx,.txt" hidden>

<!-- ðŸ”µ PROFILE MODAL -->
<div id="profileModal" class="modal">
    <div class="modal-content">
        <h3>Set Your Profile</h3>
        <input type="text" id="userNameInput" placeholder="Enter your name"><br>
        <input type="file" id="profileFileInput" accept="image/*"><br>
        <button onclick="saveProfile()">Save</button>
    </div>
</div>

<!-- ðŸ”µ HISTORY MODAL -->
<div id="historyModal" class="modal">
    <div class="modal-content">
        <h3>Chat History</h3>
        <div id="historyContent"></div>
        <button class="close-btn" onclick="document.getElementById('historyModal').style.display='none'">X</button>
    </div>
</div>

<!-- ðŸ”µ TIP MODAL -->
<div id="tipModal" class="modal">
    <div class="modal-content">
        <h3>Send a Tip</h3>
        <input type="number" id="tipAmount" placeholder="Amount"><br>
        <button id="sendTipBtn">Send Tip</button>
        <button class="close-btn" onclick="document.getElementById('tipModal').style.display='none'">X</button>
    </div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
let currentUser = { name: "", profile: "" };
let onlineUsersList = [];
let typingTimeout;
let messages = [];
const VISIBLE_COUNT = 50;

const scrollContainer = document.getElementById("contentArea");
const newMessageBadge = document.getElementById("newMessageBadge");

// ðŸ”¹ Connect to backend
const socket = io("https://cchat-6.onrender.com");

// ===== Helper: Convert image to Base64 =====
function toBase64(file){
    return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = ()=>resolve(reader.result);
        reader.onerror = err=>reject(err);
    });
}

// ===== Profile Modal =====
function saveProfile(){
    const name = document.getElementById('userNameInput').value.trim();
    const file = document.getElementById('profileFileInput').files[0];
    if(!name || !file) return alert("Enter name and select profile picture!");
    toBase64(file).then(base64=>{
        currentUser = { name, profile: base64 };
        fetch("https://cchat-6.onrender.com/saveProfileURI",{
            method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(currentUser)
        });
        document.getElementById('profileModal').style.display='none';
        socket.emit("join", currentUser);
        loadMessages();
    });
}

// ===== File Picker =====
function openFilePicker(){ document.getElementById("fileInput").click(); }

// ===== Scroll Helpers =====
function isNearBottom(threshold = 50){
    return scrollContainer.scrollHeight - scrollContainer.scrollTop - scrollContainer.clientHeight < threshold;
}

// ===== Render Messages (virtualized + smooth scroll) =====
function renderMessages(){
    const nearBottom = isNearBottom();
    scrollContainer.innerHTML = "";
    const start = Math.max(0, messages.length - VISIBLE_COUNT);
    const visible = messages.slice(start);
    visible.forEach(msg => addMessage(msg, msg.senderName === currentUser.name, false));
    if(nearBottom){
        scrollContainer.scrollTo({ top: scrollContainer.scrollHeight, behavior: 'smooth' });
        newMessageBadge.style.display='none';
    }
}

// ===== Add Message =====
function addMessage(msg, isUser, autoScroll = true){
    const container = document.createElement("div");
    container.className = "message-container";
    if(isUser) container.classList.add("user");
    container.dataset.id = msg._id || "";

    const profileWrapper = document.createElement("div");
    profileWrapper.style.position = "relative";

    const profile = document.createElement("img");
    profile.src = msg.senderProfile || "https://i.pravatar.cc/150?img=32";
    profile.className = "profile";
    profile.style.cursor = "pointer";
    profile.onclick = () => {
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.display = "flex";
        modal.style.justifyContent = "center";
        modal.style.alignItems = "center";
        modal.style.background = "rgba(0,0,0,0.7)";
        modal.innerHTML = `<img src="${msg.senderProfile}" style="max-width:90%; max-height:90%; border-radius:10px;">`;
        modal.onclick = () => modal.remove();
        document.body.appendChild(modal);
    };

    const onlineDot = document.createElement("span");
    onlineDot.className = "online-dot";
    onlineDot.style.display = onlineUsersList.some(u => u.name === msg.senderName) ? "block" : "none";

    profileWrapper.appendChild(profile);
    profileWrapper.appendChild(onlineDot);
    container.appendChild(profileWrapper);

    const content = document.createElement("div");
    content.className = "message " + (isUser ? "user" : "other");

    if(msg.type === "text") content.textContent = msg.content;
    else if(msg.type === "image"){
        const img = document.createElement("img");
        img.src = msg.content;
        img.style.borderRadius = "10px";
        content.appendChild(img);
    } else if(msg.type === "document"){
        const docName = msg.content.split("/").pop();
        content.innerHTML = `<div class="doc"><i class="fa-solid fa-file"></i> <a href="${msg.content}" target="_blank">${docName}</a></div>`;
    }

    const nameEl = document.createElement("div");
    nameEl.style.fontSize = "0.8rem";
    nameEl.style.color = "gray";
    nameEl.textContent = msg.senderName;

    const timeEl = document.createElement("div");
    timeEl.className = "timestamp";
    timeEl.textContent = new Date(msg.timestamp).toLocaleTimeString();

    const statusEl = document.createElement("div");
    statusEl.className = "status";
    statusEl.textContent = isUser ? (msg.status || "âœ“ sending") : "";

    content.appendChild(nameEl);
    content.appendChild(timeEl);
    content.appendChild(statusEl);

    container.appendChild(content);
    scrollContainer.appendChild(container);

    if(autoScroll){
        if(isNearBottom()){
            scrollContainer.scrollTo({ top: scrollContainer.scrollHeight, behavior: 'smooth' });
            newMessageBadge.style.display='none';
        } else {
            newMessageBadge.style.display='block';
        }
    }

    container.ondblclick = () => {
        if(msg._id){
            fetch(`https://cchat-6.onrender.com/message/${msg._id}`, { method: "DELETE" });
            container.remove();
            socket.emit("deleteMessage", msg._id);
        }
    }

    return statusEl;
}

// ===== Load messages from backend =====
async function loadMessages(){
    const res = await fetch("https://cchat-6.onrender.com/messages");
    messages = await res.json();
    renderMessages();
}

// ===== Send Message =====
document.getElementById("sendBtn").addEventListener("click", async ()=>{
    if(!currentUser.name || !currentUser.profile) return alert("Set your profile first!");
    const input = document.getElementById("messageInput");
    const text = input.value.trim();
    if(!text) return;

    const msgObj = { senderName: currentUser.name, senderProfile: currentUser.profile, type:"text", content:text, timestamp:new Date(), status:"sending" };
    const statusEl = addMessage(msgObj,true);

    const res = await fetch("https://cchat-6.onrender.com/saveMessageURI",{
        method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(msgObj)
    });
    const savedMsg = await res.json();
    statusEl.textContent = "âœ“ delivered";
    socket.emit("messageSent", savedMsg);
    input.value="";
});

// ===== File Upload =====
document.getElementById("fileInput").addEventListener("change", async function(e){
    for(const file of this.files){
        const base64 = await toBase64(file);
        const type = file.type.startsWith("image/")?"image":"document";
        const msgObj = { senderName: currentUser.name, senderProfile: currentUser.profile, type, content:base64, timestamp:new Date(), status:"sending" };
        const statusEl = addMessage(msgObj,true);

        const res = await fetch('https://cchat-6.onrender.com/saveMessageURI',{
            method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(msgObj)
        });
        const savedMsg = await res.json();
        statusEl.textContent = "âœ“ delivered";
        socket.emit("messageSent", savedMsg);
    }
    this.value="";
});

// ===== Typing Indicator =====
document.getElementById("messageInput").addEventListener("input", () => {
    socket.emit("typing", { user: currentUser.name });
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => socket.emit("stopTyping", { user: currentUser.name }), 1000);
});

socket.on("userTyping", data => document.getElementById("typingIndicator").textContent = `${data.user} is typing...`);
socket.on("userStopTyping", data => document.getElementById("typingIndicator").textContent = "");

// ===== Modals =====
function openHistory(){
    const historyModal = document.getElementById('historyModal');
    const historyContent = document.getElementById('historyContent');
    historyContent.innerHTML = "";
    fetch("https://cchat-6.onrender.com").then(res=>res.json()).then(messages=>{
        messages.forEach(msg=>{
            const div = document.createElement('div');
            div.style.padding="5px"; div.style.borderBottom="1px solid #ccc";
            div.innerHTML = `<strong>${msg.senderName}</strong>: ${msg.type==='text'?msg.content:(msg.type==='image'?'<i>Image</i>':'<i>Document</i>')} <span style="float:right; font-size:0.7rem; color:gray;">${new Date(msg.timestamp).toLocaleTimeString()}</span>`;
            historyContent.appendChild(div);
        });
    });
    historyModal.style.display='flex';
}
function openTip(){ document.getElementById('tipModal').style.display='flex'; }
document.getElementById("sendTipBtn").onclick = ()=>{
    const amount = document.getElementById("tipAmount").value;
    if(amount && amount>0){
        socket.emit("sendTip",{ to: currentUser.name, amount:Number(amount) });
        document.getElementById("tipModal").style.display='none';
        document.getElementById("tipAmount").value="";
    } else alert("Enter a valid amount");
};

// ===== Socket.IO Events =====

// New message received
socket.on("newMessage", msg => {
    messages.push(msg);
    addMessage(msg, msg.senderName === currentUser.name, true);
});

// Message deleted
socket.on("deleteMessage", id => {
    const el = document.querySelector(`[data-id='${id}']`);
    if (el) el.remove();
    messages = messages.filter(m => m._id !== id);
});

// Online users update
socket.on("onlineUsers", users => {
    onlineUsersList = users;
    document.getElementById("onlineCount").textContent = `${users.length} Online`;
    // Update online dots
    document.querySelectorAll(".message-container").forEach(container => {
        const img = container.querySelector(".profile");
        const dot = container.querySelector(".online-dot");
        if (img && dot) {
            const msgSender = container.querySelector(".message div").textContent;
            dot.style.display = users.some(u => u.name === msgSender) ? "block" : "none";
        }
    });
});

// Tip received
socket.on("tipReceived", data => {
    let tipCount = document.getElementById("tipCount");
    tipCount.textContent = parseInt(tipCount.textContent) + data.amount;
    // small animation
    tipCount.style.transform = "scale(1.5)";
    setTimeout(() => tipCount.style.transform = "scale(1)", 300);
});

// Scroll listener for "New Messages" badge
scrollContainer.addEventListener("scroll", () => {
    if (isNearBottom()) {
        newMessageBadge.style.display = "none";
    }
});

// Click badge to scroll to bottom
newMessageBadge.addEventListener("click", () => {
    scrollContainer.scrollTo({ top: scrollContainer.scrollHeight, behavior: 'smooth' });
    newMessageBadge.style.display = "none";
});

// Initial load
window.onload = () => {
    if(currentUser.name && currentUser.profile){
        socket.emit("join", currentUser);
        loadMessages();
    } else {
        document.getElementById('profileModal').style.display='flex';
    }
};
</script>
</body>
</html>