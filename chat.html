<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; font-family:'Segoe UI',sans-serif; display:flex; height:100vh; background:linear-gradient(135deg, rgba(0,0,0,0.8), rgba(40,40,40,0.8)); color:#fff; }
#users { width:250px; background: rgba(255,255,255,0.08); border-right:1px solid rgba(255,255,255,0.15); padding:15px; display:flex; flex-direction:column; align-items:center; overflow-y:auto; }
#users h1 { font-size:24px; margin-bottom:10px; color:gold; }
#users-list { list-style:none; padding:0; margin:0; width:100%; }
.user-item { display:flex; align-items:center; margin-bottom:8px; cursor:pointer; padding:5px; border-radius:6px; transition: background 0.2s; }
.user-item:hover { background: rgba(255,215,0,0.15); }
.user-avatar { width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#000; font-weight:bold; margin-right:10px; flex-shrink:0; }
.status-dot { width:10px; height:10px; border-radius:50%; margin-left:auto; margin-right:2px; border:1px solid #000; }
.status-online { background:#90ee90; }
.status-offline { background:gray; }
.status-typing { background:#ffd700; animation: blink 1s infinite; }
@keyframes blink { 0%,50%,100%{opacity:1;}25%,75%{opacity:0;} }

#chat { flex:1; display:flex; flex-direction:column; background: rgba(255,255,255,0.05); }
#messages { flex:1; padding:20px; overflow-y:auto; font-size:15px; }
.message { margin-bottom:10px; padding:8px 12px; border-radius:8px; max-width:80%; display:flex; align-items:center; }
.message-avatar { width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#000; font-weight:bold; margin-right:10px; flex-shrink:0; }
.message-content { display:flex; flex-direction:column; }
.message .username { font-weight:bold; margin-right:5px; }
.message .timestamp { font-size:11px; color:#ccc; margin-left:5px; }
.private-label { font-size:12px; color:#ffd700; margin-left:5px; font-weight:bold; }
.system { color:#ccc; font-style:italic; margin-bottom:5px; }
#message-form { display:flex; padding:10px; border-top:1px solid rgba(255,255,255,0.2); }
#message-input { flex:1; padding:10px; border:none; border-radius:6px; background: rgba(255,255,255,0.1); color:#fff; outline:none; }
#message-submit { padding:10px 20px; margin-left:10px; border:none; border-radius:6px; background: linear-gradient(135deg, #ffd700, #ffb700); color:#000; font-weight:bold; cursor:pointer; }
.typing-indicator { font-size:13px; color:#ccc; font-style:italic; margin-bottom:5px; }
</style>
</head>
<body>

<div id="users">
  <h1>CLChat ðŸ’«</h1>
  <h3>Online Users</h3>
  <input type="text" id="user-search" placeholder="Search users..." autocomplete="off">
  <ul id="users-list"></ul>
</div>

<div id="chat">
  <div id="messages"></div>
  <div id="typing"></div>
  <form id="message-form">
    <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off">
    <button type="submit" id="message-submit">Send</button>
  </form>
</div>

<!-- Socket.IO client -->
<script src="https://chacha2004-wxjk.onrender.com/socket.io/socket.io.js"></script>
<script>
const BACKEND_URL = 'https://chacha2004-wxjk.onrender.com'; // <-- Change this if needed

const socket = io(BACKEND_URL);
let username = prompt("Enter your username:") || "Anonymous";
let privateReceiver = null;

const usersListEl = document.getElementById("users-list");
const messagesEl = document.getElementById("messages");
const messageForm = document.getElementById("message-form");
const messageInput = document.getElementById("message-input");
const typingEl = document.getElementById("typing");

const colors = ['#FF4500','#FF8C00','#FFD700','#32CD32','#1E90FF','#8A2BE2','#FF69B4','#00CED1'];
function getColor(name){ let hash=0; for(let i=0;i<name.length;i++){ hash=name.charCodeAt(i)+((hash<<5)-hash); } return colors[Math.abs(hash)%colors.length]; }
function getInitials(name){ return name.split(' ').map(n=>n[0].toUpperCase()).join('').slice(0,2); }

let onlineUsers = {};
let typingUsers = new Set();

// Connect and announce user
socket.emit("user joined", username);

// Update user list
socket.on("users update", list=>{
  onlineUsers={}; list.forEach(u=>onlineUsers[u]=true);
  updateUsersList(list);
});

// Handle chat history and messages
socket.on("chat history", msgs => msgs.forEach(addMessage));
socket.on("receive message", addMessage);

// Typing events
socket.on("typing", data=>{
  if(data.sender!==username){
    typingUsers.add(data.sender);
    updateTyping();
    setTimeout(()=>{ typingUsers.delete(data.sender); updateTyping(); },2000);
  }
});

// âœ… FETCH chat history from backend when page loads
fetch(`${BACKEND_URL}/api/messages`)
  .then(res => {
    if (!res.ok) throw new Error('Failed to fetch messages');
    return res.json();
  })
  .then(messages => {
    messages.forEach(addMessage);
    console.log('Loaded messages from backend:', messages);
  })
  .catch(err => console.error('Fetch error:', err));

// Form submit to send message
messageForm.addEventListener("submit", e=>{
  e.preventDefault();
  const text = messageInput.value.trim();
  if(!text) return;

  const msg = { sender: username, text, receiver: privateReceiver };
  socket.emit("send message", msg);
  addMessage(msg);

  // Optionally save message to backend (using fetch)
  fetch(`${BACKEND_URL}/api/messages`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(msg)
  }).catch(err => console.error('Failed to save message:', err));

  messageInput.value="";
});

messageInput.addEventListener("input", ()=>{
  socket.emit("typing", { sender: username });
});

function updateUsersList(list){
  usersListEl.innerHTML="";
  list.forEach(user=>{
    const li=document.createElement("li");
    li.className="user-item";

    const avatar=document.createElement("div");
    avatar.className="user-avatar";
    avatar.style.backgroundColor=getColor(user);
    avatar.textContent=getInitials(user);

    const status=document.createElement("div");
    status.className="status-dot "+(typingUsers.has(user)?"status-typing":(onlineUsers[user]?"status-online":"status-offline"));

    li.appendChild(avatar);
    li.appendChild(document.createTextNode(user));
    li.appendChild(status);

    if(user!==username) li.onclick=()=>{ privateReceiver=user; alert("Private chat with "+user); };
    usersListEl.appendChild(li);
  });
}

function addMessage(msg){
  const div=document.createElement("div");
  div.className="message";
  if(msg.receiver && msg.receiver===username) div.style.background="rgba(255,215,0,0.15)";

  const avatar=document.createElement("div");
  avatar.className="message-avatar";
  avatar.style.backgroundColor=getColor(msg.sender);
  avatar.textContent=getInitials(msg.sender);

  const content=document.createElement("div");
  content.className="message-content";

  const header=document.createElement("div");
  header.innerHTML=`<span class="username">${msg.sender}</span> 
                    <span class="timestamp">${msg.timestamp || ''}</span>`;
  const body=document.createElement("div");
  body.textContent=msg.text;

  content.appendChild(header);
  content.appendChild(body);

  div.appendChild(avatar);
  div.appendChild(content);
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function updateTyping(){
  typingEl.innerHTML = typingUsers.size
    ? Array.from(typingUsers).join(", ") + " typing..."
    : "";
}
</script>
</body>
</html>